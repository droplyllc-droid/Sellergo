// =============================================================================
// SELLERGO DATABASE SCHEMA
// Multi-tenant e-commerce platform with Row Level Security
// =============================================================================

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema", "postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [pgcrypto, uuid_ossp]
}

// =============================================================================
// ENUMS
// =============================================================================

enum UserStatus {
  PENDING
  ACTIVE
  SUSPENDED
  DELETED
}

enum UserRole {
  OWNER
  ADMIN
  MANAGER
  STAFF
  READ_ONLY
}

enum MfaMethod {
  TOTP
  SMS
  EMAIL
  WEBAUTHN
}

enum StoreStatus {
  ACTIVE
  PAUSED
  SUSPENDED
  DELETED
}

enum StorePlan {
  FREE
  STARTER
  GROWTH
  ENTERPRISE
}

enum ProductStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  IN_TRANSIT
  DELIVERED
  CANCELLED
  RETURNED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PAID
  PARTIALLY_PAID
  REFUNDED
  FAILED
}

enum PaymentMethod {
  COD
  CARD
  BANK_TRANSFER
}

enum FulfillmentStatus {
  UNFULFILLED
  PARTIALLY_FULFILLED
  FULFILLED
}

enum OrderSource {
  STOREFRONT
  MANUAL
  IMPORT
  API
}

enum CustomerStatus {
  ACTIVE
  BLOCKED
}

enum BlockType {
  MANUAL
  IP
  PHONE
  EMAIL
  PERMANENT
}

enum TransactionType {
  TOP_UP
  ORDER_FEE
  REFUND
  ADJUSTMENT
  SUBSCRIPTION
  BONUS
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum InvoiceStatus {
  DRAFT
  OPEN
  PAID
  VOID
  UNCOLLECTIBLE
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELLED
  UNPAID
  TRIALING
}

enum TeamMemberStatus {
  PENDING
  ACTIVE
  REVOKED
}

enum OAuthProvider {
  GOOGLE
  FACEBOOK
}

enum PixelProvider {
  META
  TIKTOK
  SNAPCHAT
  TWITTER
  PINTEREST
}

enum AnalyticsProvider {
  GOOGLE_ANALYTICS
  GOOGLE_TAG_MANAGER
  GOOGLE_ADS
}

enum WebhookEvent {
  ORDER_CREATED
  ORDER_UPDATED
  ORDER_CONFIRMED
  ORDER_SHIPPED
  ORDER_DELIVERED
  ORDER_CANCELLED
  PRODUCT_CREATED
  PRODUCT_UPDATED
  PRODUCT_DELETED
  CUSTOMER_CREATED
  CUSTOMER_UPDATED
  CART_ABANDONED
  LOW_STOCK
}

// =============================================================================
// USER & AUTH
// =============================================================================

model User {
  id                   String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email                String      @unique
  emailVerified        Boolean     @default(false) @map("email_verified")
  emailVerifiedAt      DateTime?   @map("email_verified_at")
  passwordHash         String      @map("password_hash")
  firstName            String      @map("first_name")
  lastName             String      @map("last_name")
  avatarUrl            String?     @map("avatar_url")
  status               UserStatus  @default(PENDING)
  preferredLanguage    String      @default("en") @map("preferred_language")
  mfaEnabled           Boolean     @default(false) @map("mfa_enabled")
  mfaMethod            MfaMethod?  @map("mfa_method")
  mfaSecret            String?     @map("mfa_secret")
  mfaBackupCodes       String[]    @map("mfa_backup_codes")
  lastLoginAt          DateTime?   @map("last_login_at")
  lastLoginIp          String?     @map("last_login_ip")
  failedLoginAttempts  Int         @default(0) @map("failed_login_attempts")
  lockedUntil          DateTime?   @map("locked_until")
  createdAt            DateTime    @default(now()) @map("created_at")
  updatedAt            DateTime    @updatedAt @map("updated_at")

  // Relations
  sessions         Session[]
  oauthAccounts    OAuthAccount[]
  ownedStores      Store[]          @relation("StoreOwner")
  memberships      StoreMember[]
  invitationsSent  TeamInvitation[] @relation("InvitedBy")
  authAuditLogs    AuthAuditLog[]
  activityLogs     ActivityLog[]

  @@index([email])
  @@index([status])
  @@map("users")
}

model Session {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId           String   @map("user_id") @db.Uuid
  refreshTokenHash String   @map("refresh_token_hash")
  userAgent        String   @map("user_agent")
  ipAddress        String   @map("ip_address")
  expiresAt        DateTime @map("expires_at")
  revokedAt        DateTime? @map("revoked_at")
  lastActivityAt   DateTime @default(now()) @map("last_activity_at")
  createdAt        DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([refreshTokenHash])
  @@index([expiresAt])
  @@map("sessions")
}

model OAuthAccount {
  id                String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId            String        @map("user_id") @db.Uuid
  provider          OAuthProvider
  providerAccountId String        @map("provider_account_id")
  email             String?
  createdAt         DateTime      @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("oauth_accounts")
}

model AuthAuditLog {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  tenantId  String?  @map("tenant_id") @db.Uuid
  action    String
  ipAddress String   @map("ip_address")
  userAgent String   @map("user_agent")
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tenantId])
  @@index([action])
  @@index([createdAt])
  @@map("auth_audit_logs")
}

model EmailVerificationToken {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email     String
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([email])
  @@index([token])
  @@map("email_verification_tokens")
}

model PasswordResetToken {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([token])
  @@map("password_reset_tokens")
}

// =============================================================================
// TENANT & STORE
// =============================================================================

model Tenant {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations (all tenant-scoped data)
  stores          Store[]
  billingAccounts BillingAccount[]

  @@map("tenants")
}

model Store {
  id                    String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId              String       @map("tenant_id") @db.Uuid
  ownerId               String       @map("owner_id") @db.Uuid
  name                  String
  slug                  String       @unique
  description           String?
  logoUrl               String?      @map("logo_url")
  faviconUrl            String?      @map("favicon_url")
  currency              String       @default("TND")
  defaultLanguage       String       @default("en") @map("default_language")
  supportedLanguages    String[]     @default(["en"]) @map("supported_languages")
  timezone              String       @default("Africa/Tunis")
  status                StoreStatus  @default(ACTIVE)
  plan                  StorePlan    @default(FREE)

  // Contact
  contactEmail          String?      @map("contact_email")
  contactPhone          String?      @map("contact_phone")
  contactWhatsapp       String?      @map("contact_whatsapp")

  // Business Address
  businessStreet        String?      @map("business_street")
  businessCity          String?      @map("business_city")
  businessState         String?      @map("business_state")
  businessPostalCode    String?      @map("business_postal_code")
  businessCountry       String?      @map("business_country")

  // Settings (JSON for flexibility)
  settings              Json         @default("{}")

  // Domain
  subdomain             String       @unique
  customDomain          String?      @unique @map("custom_domain")
  customDomainVerified  Boolean      @default(false) @map("custom_domain_verified")

  // SEO
  seoTitle              String?      @map("seo_title")
  seoDescription        String?      @map("seo_description")
  seoKeywords           String[]     @default([]) @map("seo_keywords")
  seoOgImage            String?      @map("seo_og_image")

  // Tracking
  visitTrackingEnabled  Boolean      @default(true) @map("visit_tracking_enabled")

  createdAt             DateTime     @default(now()) @map("created_at")
  updatedAt             DateTime     @updatedAt @map("updated_at")

  // Relations
  tenant                Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  owner                 User         @relation("StoreOwner", fields: [ownerId], references: [id])
  members               StoreMember[]
  invitations           TeamInvitation[]
  products              Product[]
  categories            Category[]
  orders                Order[]
  abandonedCarts        AbandonedCart[]
  customers             Customer[]
  customerBlocks        CustomerBlock[]
  domains               StoreDomain[]
  navigationMenus       NavigationMenu[]
  adPixels              AdPixel[]
  analyticsIntegrations AnalyticsIntegration[]
  webhooks              Webhook[]
  installedApps         InstalledApp[]
  carrierConnections    CarrierConnection[]
  activityLogs          ActivityLog[]

  @@index([tenantId])
  @@index([ownerId])
  @@index([slug])
  @@index([subdomain])
  @@index([customDomain])
  @@index([status])
  @@map("stores")
}

model StoreMember {
  id                String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId          String           @map("tenant_id") @db.Uuid
  storeId           String           @map("store_id") @db.Uuid
  userId            String           @map("user_id") @db.Uuid
  role              UserRole
  customPermissions String[]         @default([]) @map("custom_permissions")
  status            TeamMemberStatus @default(PENDING)
  invitedAt         DateTime         @default(now()) @map("invited_at")
  acceptedAt        DateTime?        @map("accepted_at")
  lastActivityAt    DateTime?        @map("last_activity_at")
  createdAt         DateTime         @default(now()) @map("created_at")
  updatedAt         DateTime         @updatedAt @map("updated_at")

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([storeId, userId])
  @@index([tenantId])
  @@index([storeId])
  @@index([userId])
  @@map("store_members")
}

model TeamInvitation {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId          String   @map("tenant_id") @db.Uuid
  storeId           String   @map("store_id") @db.Uuid
  email             String
  role              UserRole
  customPermissions String[] @default([]) @map("custom_permissions")
  invitedById       String   @map("invited_by_id") @db.Uuid
  inviteToken       String   @unique @map("invite_token")
  expiresAt         DateTime @map("expires_at")
  acceptedAt        DateTime? @map("accepted_at")
  revokedAt         DateTime? @map("revoked_at")
  createdAt         DateTime @default(now()) @map("created_at")

  store     Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
  invitedBy User  @relation("InvitedBy", fields: [invitedById], references: [id])

  @@index([tenantId])
  @@index([storeId])
  @@index([email])
  @@index([inviteToken])
  @@map("team_invitations")
}

model StoreDomain {
  id                 String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId           String   @map("tenant_id") @db.Uuid
  storeId            String   @map("store_id") @db.Uuid
  domain             String   @unique
  type               String   @default("custom")
  isPrimary          Boolean  @default(false) @map("is_primary")
  isVerified         Boolean  @default(false) @map("is_verified")
  verificationToken  String?  @map("verification_token")
  verificationMethod String?  @map("verification_method")
  verifiedAt         DateTime? @map("verified_at")
  sslStatus          String   @default("pending") @map("ssl_status")
  sslIssuedAt        DateTime? @map("ssl_issued_at")
  sslExpiresAt       DateTime? @map("ssl_expires_at")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([storeId])
  @@index([domain])
  @@map("store_domains")
}

model NavigationMenu {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  storeId   String   @map("store_id") @db.Uuid
  type      String   // header, footer
  column    Int?
  title     String?
  items     Json     @default("[]")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([storeId])
  @@map("navigation_menus")
}

// =============================================================================
// PRODUCTS
// =============================================================================

model Product {
  id                  String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId            String        @map("tenant_id") @db.Uuid
  storeId             String        @map("store_id") @db.Uuid
  name                String
  slug                String
  description         String?
  shortDescription    String?       @map("short_description")
  status              ProductStatus @default(DRAFT)

  // Pricing
  price               Decimal       @db.Decimal(10, 2)
  compareAtPrice      Decimal?      @map("compare_at_price") @db.Decimal(10, 2)
  costPerItem         Decimal?      @map("cost_per_item") @db.Decimal(10, 2)

  // Inventory
  sku                 String?
  barcode             String?
  trackQuantity       Boolean       @default(true) @map("track_quantity")
  quantity            Int           @default(0)
  lowStockThreshold   Int           @default(10) @map("low_stock_threshold")

  // Organization
  categoryId          String?       @map("category_id") @db.Uuid
  tags                String[]      @default([])

  // Variants
  hasVariants         Boolean       @default(false) @map("has_variants")
  variantOptions      Json          @default("[]") @map("variant_options")

  // Offers
  quantityOffers      Json          @default("[]") @map("quantity_offers")
  upsells             Json          @default("[]")

  // Promo
  promoMessage        String?       @map("promo_message")
  promoMessageEnabled Boolean       @default(false) @map("promo_message_enabled")

  // Reviews
  averageRating       Decimal       @default(0) @map("average_rating") @db.Decimal(2, 1)
  reviewCount         Int           @default(0) @map("review_count")
  showReviews         Boolean       @default(true) @map("show_reviews")

  // Shipping
  weight              Decimal?      @db.Decimal(10, 2)
  weightUnit          String        @default("kg") @map("weight_unit")
  requiresShipping    Boolean       @default(true) @map("requires_shipping")
  shippingPrice       Decimal?      @map("shipping_price") @db.Decimal(10, 2)
  freeShipping        Boolean       @default(false) @map("free_shipping")

  // SEO
  seoTitle            String?       @map("seo_title")
  seoDescription      String?       @map("seo_description")
  seoKeywords         String[]      @default([]) @map("seo_keywords")

  // Stats
  totalSold           Int           @default(0) @map("total_sold")
  totalRevenue        Decimal       @default(0) @map("total_revenue") @db.Decimal(12, 2)
  viewCount           Int           @default(0) @map("view_count")

  createdAt           DateTime      @default(now()) @map("created_at")
  updatedAt           DateTime      @updatedAt @map("updated_at")

  // Relations
  store               Store         @relation(fields: [storeId], references: [id], onDelete: Cascade)
  category            Category?     @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  images              ProductImage[]
  variants            ProductVariant[]
  reviews             ProductReview[]
  orderItems          OrderItem[]

  @@unique([storeId, slug])
  @@index([tenantId])
  @@index([storeId])
  @@index([categoryId])
  @@index([status])
  @@index([name])
  @@map("products")
}

model ProductImage {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  productId String   @map("product_id") @db.Uuid
  url       String
  alt       String?
  position  Int      @default(0)
  width     Int?
  height    Int?
  createdAt DateTime @default(now()) @map("created_at")

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([productId])
  @@map("product_images")
}

model ProductVariant {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId       String   @map("tenant_id") @db.Uuid
  storeId        String   @map("store_id") @db.Uuid
  productId      String   @map("product_id") @db.Uuid
  sku            String?
  barcode        String?
  price          Decimal  @db.Decimal(10, 2)
  compareAtPrice Decimal? @map("compare_at_price") @db.Decimal(10, 2)
  costPerItem    Decimal? @map("cost_per_item") @db.Decimal(10, 2)
  quantity       Int      @default(0)
  trackQuantity  Boolean  @default(true) @map("track_quantity")
  options        Json     @default("{}")
  imageId        String?  @map("image_id") @db.Uuid
  position       Int      @default(0)
  isDefault      Boolean  @default(false) @map("is_default")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([storeId])
  @@index([productId])
  @@map("product_variants")
}

model Category {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId     String   @map("tenant_id") @db.Uuid
  storeId      String   @map("store_id") @db.Uuid
  name         String
  slug         String
  description  String?
  imageUrl     String?  @map("image_url")
  parentId     String?  @map("parent_id") @db.Uuid
  position     Int      @default(0)
  productCount Int      @default(0) @map("product_count")
  isActive     Boolean  @default(true) @map("is_active")
  seoTitle     String?  @map("seo_title")
  seoDescription String? @map("seo_description")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  store    Store      @relation(fields: [storeId], references: [id], onDelete: Cascade)
  parent   Category?  @relation("CategoryParent", fields: [parentId], references: [id], onDelete: SetNull)
  children Category[] @relation("CategoryParent")
  products Product[]

  @@unique([storeId, slug])
  @@index([tenantId])
  @@index([storeId])
  @@index([parentId])
  @@map("categories")
}

model ProductReview {
  id                 String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId           String   @map("tenant_id") @db.Uuid
  storeId            String   @map("store_id") @db.Uuid
  productId          String   @map("product_id") @db.Uuid
  customerId         String?  @map("customer_id") @db.Uuid
  orderId            String?  @map("order_id") @db.Uuid
  rating             Int
  title              String?
  content            String?
  customerName       String   @map("customer_name")
  customerEmail      String?  @map("customer_email")
  isVerifiedPurchase Boolean  @default(false) @map("is_verified_purchase")
  isApproved         Boolean  @default(false) @map("is_approved")
  approvedAt         DateTime? @map("approved_at")
  images             Json     @default("[]")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  product  Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  customer Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([storeId])
  @@index([productId])
  @@index([customerId])
  @@map("product_reviews")
}

// =============================================================================
// ORDERS
// =============================================================================

model Order {
  id                    String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId              String            @map("tenant_id") @db.Uuid
  storeId               String            @map("store_id") @db.Uuid
  orderNumber           String            @map("order_number")
  customerId            String?           @map("customer_id") @db.Uuid

  // Status
  status                OrderStatus       @default(PENDING)
  paymentStatus         PaymentStatus     @default(PENDING) @map("payment_status")
  fulfillmentStatus     FulfillmentStatus @default(UNFULFILLED) @map("fulfillment_status")

  // Customer info
  customerEmail         String?           @map("customer_email")
  customerPhone         String            @map("customer_phone")
  customerName          String            @map("customer_name")

  // Shipping address
  shippingStreet        String            @map("shipping_street")
  shippingCity          String            @map("shipping_city")
  shippingState         String?           @map("shipping_state")
  shippingPostalCode    String?           @map("shipping_postal_code")
  shippingCountry       String            @map("shipping_country")

  // Pricing
  subtotal              Decimal           @db.Decimal(12, 2)
  shippingCost          Decimal           @default(0) @map("shipping_cost") @db.Decimal(10, 2)
  discount              Decimal           @default(0) @db.Decimal(10, 2)
  total                 Decimal           @db.Decimal(12, 2)
  currency              String            @default("TND")

  // Payment
  paymentMethod         PaymentMethod     @default(COD) @map("payment_method")
  paidAt                DateTime?         @map("paid_at")
  paidAmount            Decimal           @default(0) @map("paid_amount") @db.Decimal(12, 2)

  // Source
  source                OrderSource       @default(STOREFRONT)
  sourceIp              String?           @map("source_ip")
  sourceUrl             String?           @map("source_url")
  utmSource             String?           @map("utm_source")
  utmMedium             String?           @map("utm_medium")
  utmCampaign           String?           @map("utm_campaign")

  // Delivery
  carrierId             String?           @map("carrier_id") @db.Uuid
  carrierName           String?           @map("carrier_name")
  trackingNumber        String?           @map("tracking_number")
  trackingUrl           String?           @map("tracking_url")
  estimatedDeliveryDate DateTime?         @map("estimated_delivery_date")
  shippedAt             DateTime?         @map("shipped_at")
  deliveredAt           DateTime?         @map("delivered_at")

  // Notes
  customerNote          String?           @map("customer_note")
  internalNote          String?           @map("internal_note")

  // Timestamps
  confirmedAt           DateTime?         @map("confirmed_at")
  cancelledAt           DateTime?         @map("cancelled_at")
  cancellationReason    String?           @map("cancellation_reason")

  // Platform fees
  platformFee           Decimal           @default(0) @map("platform_fee") @db.Decimal(10, 2)
  platformFeeRate       Decimal           @default(0.0027) @map("platform_fee_rate") @db.Decimal(6, 4)

  createdAt             DateTime          @default(now()) @map("created_at")
  updatedAt             DateTime          @updatedAt @map("updated_at")

  // Relations
  store                 Store             @relation(fields: [storeId], references: [id], onDelete: Cascade)
  customer              Customer?         @relation(fields: [customerId], references: [id], onDelete: SetNull)
  items                 OrderItem[]
  timeline              OrderTimelineEvent[]

  @@unique([storeId, orderNumber])
  @@index([tenantId])
  @@index([storeId])
  @@index([customerId])
  @@index([status])
  @@index([paymentStatus])
  @@index([createdAt])
  @@index([customerPhone])
  @@map("orders")
}

model OrderItem {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId   String   @map("tenant_id") @db.Uuid
  orderId    String   @map("order_id") @db.Uuid
  productId  String   @map("product_id") @db.Uuid
  variantId  String?  @map("variant_id") @db.Uuid
  name       String
  sku        String?
  imageUrl   String?  @map("image_url")
  quantity   Int
  unitPrice  Decimal  @map("unit_price") @db.Decimal(10, 2)
  totalPrice Decimal  @map("total_price") @db.Decimal(10, 2)
  discount   Decimal  @default(0) @db.Decimal(10, 2)
  options    Json     @default("{}")
  isUpsell   Boolean  @default(false) @map("is_upsell")
  createdAt  DateTime @default(now()) @map("created_at")

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@index([tenantId])
  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

model OrderTimelineEvent {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  orderId     String   @map("order_id") @db.Uuid
  type        String
  title       String
  description String?
  metadata    Json?
  createdById String?  @map("created_by_id") @db.Uuid
  isSystem    Boolean  @default(true) @map("is_system")
  createdAt   DateTime @default(now()) @map("created_at")

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([orderId])
  @@map("order_timeline_events")
}

model AbandonedCart {
  id                  String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId            String   @map("tenant_id") @db.Uuid
  storeId             String   @map("store_id") @db.Uuid
  cartId              String   @map("cart_id")
  customerId          String?  @map("customer_id") @db.Uuid
  customerEmail       String?  @map("customer_email")
  customerPhone       String?  @map("customer_phone")
  customerName        String?  @map("customer_name")
  items               Json     @default("[]")
  subtotal            Decimal  @db.Decimal(12, 2)
  currency            String   @default("TND")
  abandonedAt         DateTime @default(now()) @map("abandoned_at")
  recoveryEmailSent   Boolean  @default(false) @map("recovery_email_sent")
  recoveryEmailSentAt DateTime? @map("recovery_email_sent_at")
  recoveredAt         DateTime? @map("recovered_at")
  recoveredOrderId    String?  @map("recovered_order_id") @db.Uuid
  sourceUrl           String?  @map("source_url")
  sourceIp            String?  @map("source_ip")
  createdAt           DateTime @default(now()) @map("created_at")

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@unique([storeId, cartId])
  @@index([tenantId])
  @@index([storeId])
  @@index([abandonedAt])
  @@map("abandoned_carts")
}

// =============================================================================
// CUSTOMERS
// =============================================================================

model Customer {
  id               String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId         String         @map("tenant_id") @db.Uuid
  storeId          String         @map("store_id") @db.Uuid
  email            String?
  phone            String
  firstName        String?        @map("first_name")
  lastName         String?        @map("last_name")
  status           CustomerStatus @default(ACTIVE)

  // Default address
  addressStreet     String?       @map("address_street")
  addressCity       String?       @map("address_city")
  addressState      String?       @map("address_state")
  addressPostalCode String?       @map("address_postal_code")
  addressCountry    String?       @map("address_country")

  // Stats
  totalOrders       Int           @default(0) @map("total_orders")
  totalSpent        Decimal       @default(0) @map("total_spent") @db.Decimal(12, 2)
  averageOrderValue Decimal       @default(0) @map("average_order_value") @db.Decimal(10, 2)
  lastOrderAt       DateTime?     @map("last_order_at")
  firstOrderAt      DateTime?     @map("first_order_at")

  // Marketing
  acceptsMarketing  Boolean       @default(false) @map("accepts_marketing")
  marketingOptInAt  DateTime?     @map("marketing_opt_in_at")

  // Notes
  notes             String?
  tags              String[]      @default([])

  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  // Relations
  store   Store           @relation(fields: [storeId], references: [id], onDelete: Cascade)
  orders  Order[]
  reviews ProductReview[]

  @@unique([storeId, phone])
  @@index([tenantId])
  @@index([storeId])
  @@index([email])
  @@index([phone])
  @@index([status])
  @@map("customers")
}

model CustomerBlock {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId    String    @map("tenant_id") @db.Uuid
  storeId     String    @map("store_id") @db.Uuid
  customerId  String?   @map("customer_id") @db.Uuid
  blockType   BlockType @map("block_type")
  value       String
  reason      String?
  expiresAt   DateTime? @map("expires_at")
  isPermanent Boolean   @default(false) @map("is_permanent")
  blockedById String    @map("blocked_by_id") @db.Uuid
  createdAt   DateTime  @default(now()) @map("created_at")

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([storeId])
  @@index([blockType, value])
  @@map("customer_blocks")
}

// =============================================================================
// BILLING
// =============================================================================

model BillingAccount {
  id                           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId                     String   @unique @map("tenant_id") @db.Uuid
  balance                      Decimal  @default(0) @db.Decimal(12, 2)
  currency                     String   @default("USD")
  feeRate                      Decimal  @default(0.0027) @map("fee_rate") @db.Decimal(6, 4)
  stripeCustomerId             String?  @unique @map("stripe_customer_id")
  stripePaymentMethodId        String?  @map("stripe_payment_method_id")
  lastTopUpAt                  DateTime? @map("last_top_up_at")
  lowBalanceThreshold          Decimal  @default(10) @map("low_balance_threshold") @db.Decimal(10, 2)
  lowBalanceNotificationEnabled Boolean @default(true) @map("low_balance_notification_enabled")
  autoTopUpEnabled             Boolean  @default(false) @map("auto_top_up_enabled")
  autoTopUpAmount              Decimal? @map("auto_top_up_amount") @db.Decimal(10, 2)
  autoTopUpThreshold           Decimal? @map("auto_top_up_threshold") @db.Decimal(10, 2)
  createdAt                    DateTime @default(now()) @map("created_at")
  updatedAt                    DateTime @updatedAt @map("updated_at")

  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  transactions Transaction[]
  invoices     Invoice[]

  @@index([tenantId])
  @@index([stripeCustomerId])
  @@map("billing_accounts")
}

model Transaction {
  id                String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId          String            @map("tenant_id") @db.Uuid
  billingAccountId  String            @map("billing_account_id") @db.Uuid
  type              TransactionType
  status            TransactionStatus @default(PENDING)
  amount            Decimal           @db.Decimal(12, 2)
  balanceBefore     Decimal           @map("balance_before") @db.Decimal(12, 2)
  balanceAfter      Decimal           @map("balance_after") @db.Decimal(12, 2)
  currency          String            @default("USD")
  description       String
  orderId           String?           @map("order_id") @db.Uuid
  orderNumber       String?           @map("order_number")
  paymentIntentId   String?           @map("payment_intent_id")
  paymentMethodLast4 String?          @map("payment_method_last4")
  metadata          Json?
  failureReason     String?           @map("failure_reason")
  createdAt         DateTime          @default(now()) @map("created_at")

  billingAccount BillingAccount @relation(fields: [billingAccountId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([billingAccountId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@map("transactions")
}

model Invoice {
  id               String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId         String        @map("tenant_id") @db.Uuid
  billingAccountId String        @map("billing_account_id") @db.Uuid
  invoiceNumber    String        @unique @map("invoice_number")
  periodStart      DateTime      @map("period_start")
  periodEnd        DateTime      @map("period_end")
  subtotal         Decimal       @db.Decimal(12, 2)
  tax              Decimal       @default(0) @db.Decimal(10, 2)
  total            Decimal       @db.Decimal(12, 2)
  currency         String        @default("USD")
  status           InvoiceStatus @default(DRAFT)
  paidAt           DateTime?     @map("paid_at")
  dueDate          DateTime      @map("due_date")
  items            Json          @default("[]")
  pdfUrl           String?       @map("pdf_url")
  createdAt        DateTime      @default(now()) @map("created_at")
  updatedAt        DateTime      @updatedAt @map("updated_at")

  billingAccount BillingAccount @relation(fields: [billingAccountId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([billingAccountId])
  @@index([status])
  @@map("invoices")
}

// =============================================================================
// INTEGRATIONS
// =============================================================================

model AdPixel {
  id                  String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId            String        @map("tenant_id") @db.Uuid
  storeId             String        @map("store_id") @db.Uuid
  provider            PixelProvider
  name                String
  pixelId             String        @map("pixel_id")
  accessToken         String?       @map("access_token")
  testEventCode       String?       @map("test_event_code")
  isEnabled           Boolean       @default(true) @map("is_enabled")
  enableConversionsApi Boolean      @default(false) @map("enable_conversions_api")
  events              String[]      @default([])
  createdAt           DateTime      @default(now()) @map("created_at")
  updatedAt           DateTime      @updatedAt @map("updated_at")

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([storeId])
  @@index([provider])
  @@map("ad_pixels")
}

model AnalyticsIntegration {
  id        String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId  String            @map("tenant_id") @db.Uuid
  storeId   String            @map("store_id") @db.Uuid
  provider  AnalyticsProvider
  isEnabled Boolean           @default(true) @map("is_enabled")
  config    Json              @default("{}")
  createdAt DateTime          @default(now()) @map("created_at")
  updatedAt DateTime          @updatedAt @map("updated_at")

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@unique([storeId, provider])
  @@index([tenantId])
  @@index([storeId])
  @@map("analytics_integrations")
}

model Webhook {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId        String   @map("tenant_id") @db.Uuid
  storeId         String   @map("store_id") @db.Uuid
  name            String
  url             String
  secret          String
  events          String[] @default([])
  isEnabled       Boolean  @default(true) @map("is_enabled")
  headers         Json     @default("{}")
  lastTriggeredAt DateTime? @map("last_triggered_at")
  lastStatus      Int?     @map("last_status")
  failureCount    Int      @default(0) @map("failure_count")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  store      Store             @relation(fields: [storeId], references: [id], onDelete: Cascade)
  deliveries WebhookDelivery[]

  @@index([tenantId])
  @@index([storeId])
  @@map("webhooks")
}

model WebhookDelivery {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId       String   @map("tenant_id") @db.Uuid
  webhookId      String   @map("webhook_id") @db.Uuid
  event          String
  payload        Json
  responseStatus Int?     @map("response_status")
  responseBody   String?  @map("response_body")
  duration       Int?
  success        Boolean
  errorMessage   String?  @map("error_message")
  attemptNumber  Int      @default(1) @map("attempt_number")
  nextRetryAt    DateTime? @map("next_retry_at")
  createdAt      DateTime @default(now()) @map("created_at")

  webhook Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([webhookId])
  @@index([createdAt])
  @@map("webhook_deliveries")
}

model InstalledApp {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  storeId     String   @map("store_id") @db.Uuid
  appId       String   @map("app_id")
  appName     String   @map("app_name")
  isEnabled   Boolean  @default(true) @map("is_enabled")
  config      Json     @default("{}")
  installedBy String   @map("installed_by") @db.Uuid
  installedAt DateTime @default(now()) @map("installed_at")
  lastUsedAt  DateTime? @map("last_used_at")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@unique([storeId, appId])
  @@index([tenantId])
  @@index([storeId])
  @@map("installed_apps")
}

// =============================================================================
// SHIPPING
// =============================================================================

model DeliveryCarrier {
  id                  String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                String
  code                String   @unique
  logoUrl             String?  @map("logo_url")
  description         String?
  isActive            Boolean  @default(true) @map("is_active")
  trackingUrlTemplate String?  @map("tracking_url_template")
  supportedCountries  String[] @default([]) @map("supported_countries")
  apiEndpoint         String?  @map("api_endpoint")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  connections CarrierConnection[]

  @@map("delivery_carriers")
}

model CarrierConnection {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  storeId     String   @map("store_id") @db.Uuid
  carrierId   String   @map("carrier_id") @db.Uuid
  apiKey      String?  @map("api_key")
  apiSecret   String?  @map("api_secret")
  accountId   String?  @map("account_id")
  isConnected Boolean  @default(false) @map("is_connected")
  lastSyncAt  DateTime? @map("last_sync_at")
  settings    Json     @default("{}")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  store   Store           @relation(fields: [storeId], references: [id], onDelete: Cascade)
  carrier DeliveryCarrier @relation(fields: [carrierId], references: [id], onDelete: Cascade)

  @@unique([storeId, carrierId])
  @@index([tenantId])
  @@index([storeId])
  @@map("carrier_connections")
}

// =============================================================================
// ANALYTICS & TRACKING
// =============================================================================

model AnalyticsEvent {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId   String   @map("tenant_id") @db.Uuid
  storeId    String   @map("store_id") @db.Uuid
  sessionId  String   @map("session_id")
  visitorId  String   @map("visitor_id")
  eventType  String   @map("event_type")
  eventData  Json     @default("{}") @map("event_data")
  pageUrl    String   @map("page_url")
  referrer   String?
  userAgent  String   @map("user_agent")
  ipAddress  String   @map("ip_address")
  country    String?
  city       String?
  deviceType String   @map("device_type")
  timestamp  DateTime @default(now())

  @@index([tenantId])
  @@index([storeId])
  @@index([sessionId])
  @@index([visitorId])
  @@index([eventType])
  @@index([timestamp])
  @@map("analytics_events")
}

// =============================================================================
// ACTIVITY LOG
// =============================================================================

model ActivityLog {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId     String   @map("tenant_id") @db.Uuid
  storeId      String   @map("store_id") @db.Uuid
  userId       String   @map("user_id") @db.Uuid
  action       String
  resourceType String?  @map("resource_type")
  resourceId   String?  @map("resource_id") @db.Uuid
  resourceName String?  @map("resource_name")
  metadata     Json?
  ipAddress    String?  @map("ip_address")
  createdAt    DateTime @default(now()) @map("created_at")

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([storeId])
  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("activity_logs")
}
